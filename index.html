<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Enhanced HLS Video Player">
    <meta name="author" content="Toasty360">
    <title>HLS Video Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #046307;
            --secondary-color: #2196f3;
            --background-color: #040404;
            --card-bg: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b0bec5;
            --error-color: #ff5252;
            --success-color: #4caf50;
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-color: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            background: var(--background-color);
            background-size: 400% 400%;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 95%;
            max-width: 1000px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            color: var(--secondary-color);
            position: relative;
        }

        h1::after {
            content: '';
            display: block;
            width: 60px;
            height: 4px;
            background: var(--primary-color);
            margin: 10px auto;
            border-radius: 2px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .input-field {
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.3);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        button {
            flex: 1;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button.icon-button {
            flex: 0;
            padding: 12px;
            border-radius: 10px;
        }

        #generate-url {
            background: var(--secondary-color);
            color: white;
        }

        #generate-url:hover {
            transform: translateY(-2px);
        }

        #clear-form {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        #clear-form:hover {
            background: var(--hover-color);
        }

        .toggle-mode {
            position: absolute;
            right: 0;
            top: 0;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 5px 10px;
            cursor: pointer;
        }

        .video-container {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            aspect-ratio: 16/9;
        }

        video {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: #000;
            object-fit: contain;
        }

        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: var(--success-color);
            color: white;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-message.show {
            transform: translateX(0);
        }

        .status-message.error {
            background: var(--error-color);
        }

        .header-pair {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-pair input {
            flex: 1;
        }

        .remove-header {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 5px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-header {
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mode-switch {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .stream-quality {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
        }

        .quality-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .quality-select {
            width: auto;
            min-width: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
        }

        .recent-urls {
            margin-top: 20px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .recent-urls h3 {
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .url-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .recent-url-item {
            padding: 8px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-url-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .recent-url-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 30px);
        }

        .url-delete {
            color: var(--error-color);
            opacity: 0.7;
            cursor: pointer;
        }

        .url-delete:hover {
            opacity: 1;
        }

        .collapsible {
            background: var(--card-bg);
            color: var(--text-primary);
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1rem;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:after {
            content: '\002B';
            color: var(--text-secondary);
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }



        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            background: var(--card-bg);
            border-radius: 0 0 10px 10px;
            margin-top: -10px;
            margin-bottom: 15px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .connection-indicator.offline {
            background: var(--error-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                width: 100%;
            }

            h1 {
                font-size: 1.8rem;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .header-pair {
                flex-direction: column;
                gap: 5px;
            }

            .remove-header {
                align-self: flex-end;
            }
        }

        /* Loading spinner */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .social-icons {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease;
            gap: 10px;
            display: flex;
            padding: 2px;
            margin-top: 10px;
        }

        .social-icons a i {
            cursor: pointer;
        }

        .globe {
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .offline {
            color: var(--error-color);
        }

        .video-info {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .stats {
            display: flex;
            gap: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Theme toggle */
        .theme-switch {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0"></script>
</head>

<body>
    <div class="container">
        <div class="social-icons">
            <i type="1" class="globe fa-solid fa-globe tooltip">
                <span class="tooltiptext" id="server-tooltip">Using remote server</span>
            </i>
            <a href="https://github.com/Toasty360/Roxy" target="_blank" rel="noopener noreferrer" class="tooltip">
                <i class="github fa-brands fa-github fa-xl"></i>
                <span class="tooltiptext">View on GitHub</span>
            </a>
        </div>
        <h1>HLS Video Player</h1>

        <div class="tabs">
            <div class="tab active" data-tab="url-tab">Stream URL</div>
            <div class="tab" data-tab="settings-tab">Settings</div>
        </div>

        <div id="url-tab" class="tab-content active">
            <div class="input-group">
                <div class="input-field">
                    <label for="hls-url"><i class="fas fa-link"></i> HLS URL</label>
                    <input type="text" id="hls-url" placeholder="Enter the HLS stream URL" />
                </div>

                <div class="mode-switch">
                    <button class="toggle-mode" id="toggle-header-mode">
                        <span id="header-mode-text">Switch to Key-Value Mode</span>
                    </button>
                </div>

                <div id="json-headers-container">
                    <div class="input-field">
                        <label for="headers"><i class="fas fa-code"></i> Headers (JSON format)</label>
                        <textarea id="headers"
                            placeholder='{"Referer": "https://example.com", "User-Agent": "Custom User Agent"}'></textarea>
                    </div>
                </div>

                <div id="key-value-headers-container" style="display: none;">
                    <label><i class="fas fa-list"></i> Headers (Key-Value pairs)</label>
                    <div id="header-pairs">
                        <!-- Header pairs will be added here dynamically -->
                    </div>
                    <button class="add-header" id="add-header">
                        <i class="fas fa-plus"></i> Add Header
                    </button>
                </div>
            </div>

            <div class="button-group">
                <button id="generate-url">
                    <i class="fas fa-play"></i> Play Stream
                </button>
                <button id="clear-form">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>

            <div class="video-container">
                <video id="video-player" controls playsinline></video>
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <div class="video-info" style="display: none;" id="video-info-panel">
                <div class="stats">
                    <div class="stat-item">
                        <i class="fas fa-signal"></i>
                        <span class="stat-label">Quality:</span>
                        <span class="stat-value" id="current-quality">Auto</span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span class="stat-label">Buffer:</span>
                        <span class="stat-value" id="buffer-length">0s</span>
                    </div>
                </div>
                <div class="quality-controls">
                    <select id="quality-selector" class="quality-select">
                        <option value="auto">Auto</option>
                        <!-- Quality options will be added dynamically -->
                    </select>
                </div>
            </div>

            <button class="collapsible">
                <span><i class="fas fa-history"></i> Recent Streams</span>
            </button>
            <div class="collapsible-content">
                <div class="recent-urls">
                    <div class="url-list" id="recent-urls-list">
                        <!-- Recent URLs will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="input-group">
                <div class="input-field">
                    <label for="server-url"><i class="fas fa-server"></i> Proxy Server URL</label>
                    <input type="text" id="server-url" placeholder="Enter proxy server URL" />
                </div>

                <div class="input-field">
                    <label for="buffer-length"><i class="fas fa-memory"></i> Buffer Size (seconds)</label>
                    <input type="number" id="buffer-length" min="10" max="600" value="30" />
                </div>

                <div class="input-field">
                    <label for="max-buffer"><i class="fas fa-hdd"></i> Maximum Buffer Size (seconds)</label>
                    <input type="number" id="max-buffer" min="60" max="1200" value="600" />
                </div>

                <div class="input-field">
                    <label><i class="fas fa-toggle-on"></i> Options</label>
                    <div style="display: flex; gap: 20px; margin-top: 10px;">
                        <label style="text-transform: none; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="low-latency" checked />
                            Low Latency Mode
                        </label>
                        <label style="text-transform: none; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="enable-worker" checked />
                            Enable Worker
                        </label>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="connection-status">
                    <div class="connection-indicator" id="connection-indicator"></div>
                    <span id="connection-text">Connected to remote server</span>
                </div>
                <div>
                    <span id="hls-version">HLS.js v1.4.0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="status-message" id="status-message"></div>

    <script>
        // Initialize variables
        let proxyBase = "https://slave.nopile6577.workers.dev/proxy?url=";
        let isKeyValueMode = false;
        let recentUrls = JSON.parse(localStorage.getItem('recentUrls') || '[]');
        let player = document.getElementById("video-player");
        let loading = document.querySelector(".loading");
        let statusMessage = document.getElementById("status-message");
        let currentHls = null;
        let headerPairCount = 0;
        let statsInterval = null;

        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Initialize collapsible sections
        document.querySelectorAll('.collapsible').forEach(coll => {
            coll.addEventListener('click', function () {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });

        // Load settings from localStorage
        function loadSettings() {
            // Server type
            const serverType = localStorage.getItem("serverType");
            if (serverType) {
                globe.setAttribute("type", serverType);
                const isLocal = serverType === "2";
                globe.classList.toggle("offline", isLocal);
                connectionIndicator.classList.toggle("offline", isLocal);
                serverTooltip.textContent = isLocal ? "Using local server" : "Using remote server";
                connectionText.textContent = isLocal ? "Connected to local server" : "Connected to remote server";
                proxyBase = isLocal ? "http://localhost:8787/proxy?url=" : "https://slave.nopile6577.workers.dev/proxy?url=";
            }

            // Server URL
            const serverUrl = localStorage.getItem("serverUrl");
            if (serverUrl) {
                document.getElementById("server-url").value = serverUrl;
            }

            // Buffer settings
            const bufferLength = localStorage.getItem("bufferLength");
            if (bufferLength) {
                document.getElementById("buffer-length").value = bufferLength;
            }

            const maxBuffer = localStorage.getItem("maxBuffer");
            if (maxBuffer) {
                document.getElementById("max-buffer").value = maxBuffer;
            }

            // Options
            const lowLatency = localStorage.getItem("lowLatency");
            if (lowLatency !== null) {
                document.getElementById("low-latency").checked = lowLatency === "true";
            }

            const enableWorker = localStorage.getItem("enableWorker");
            if (enableWorker !== null) {
                document.getElementById("enable-worker").checked = enableWorker === "true";
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem("serverUrl", document.getElementById("server-url").value);
            localStorage.setItem("bufferLength", document.getElementById("buffer-length").value);
            localStorage.setItem("maxBuffer", document.getElementById("max-buffer").value);
            localStorage.setItem("lowLatency", document.getElementById("low-latency").checked);
            localStorage.setItem("enableWorker", document.getElementById("enable-worker").checked);
        }

        // Add event listeners to save settings
        document.getElementById("server-url").addEventListener("change", saveSettings);
        document.getElementById("buffer-length").addEventListener("change", saveSettings);
        document.getElementById("max-buffer").addEventListener("change", saveSettings);
        document.getElementById("low-latency").addEventListener("change", saveSettings);
        document.getElementById("enable-worker").addEventListener("change", saveSettings);

        // Toggle between globe icon states (local vs remote)
        const globe = document.querySelector(".globe");
        const serverTooltip = document.getElementById("server-tooltip");
        const connectionIndicator = document.getElementById("connection-indicator");
        const connectionText = document.getElementById("connection-text");

        globe.addEventListener("click", () => {
            const isOnline = globe.getAttribute("type") === "1";
            if (isOnline) {
                proxyBase = "http://localhost:8787/proxy?url=";
                serverTooltip.textContent = "Using local server";
                connectionText.textContent = "Connected to local server";
            } else {
                proxyBase = "https://slave.nopile6577.workers.dev/proxy?url=";
                serverTooltip.textContent = "Using remote server";
                connectionText.textContent = "Connected to remote server";
            }
            globe.setAttribute("type", isOnline ? "2" : "1");
            globe.classList.toggle("offline", isOnline);
            connectionIndicator.classList.toggle("offline", isOnline);

            // Save preference
            localStorage.setItem("serverType", isOnline ? "2" : "1");

            showMessage(isOnline ? "Switched to local server" : "Switched to remote server");
        });

        // Function to show status messages
        function showMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = "status-message";
            statusMessage.classList.add(isError ? "error" : "show");

            setTimeout(() => {
                statusMessage.classList.remove("show");
            }, 3000);
        }

        // Function to get headers from either JSON or key-value pairs
        function getRequestHeaders() {
            let headers = {};

            try {
                if (isKeyValueMode) {
                    // Get from key-value pairs
                    const headerPairs = document.querySelectorAll('.header-pair');
                    headerPairs.forEach(pair => {
                        const key = pair.querySelector('.header-key').value.trim();
                        const value = pair.querySelector('.header-value').value.trim();
                        if (key) {
                            headers[key] = value;
                        }
                    });
                } else {
                    // Get from JSON textarea
                    const headersText = document.getElementById('headers').value.trim();
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }
                }
            } catch (e) {
                console.error('Error parsing headers:', e);
                showMessage('Error parsing headers - check format', true);
                return {};
            }

            // Filter out any empty/null values
            return Object.fromEntries(
                Object.entries(headers).filter(([_, v]) => v !== null && v !== undefined && v !== '')
            );
        }

        // Header mode toggle
        document.getElementById("toggle-header-mode").addEventListener("click", () => {
            isKeyValueMode = !isKeyValueMode;

            document.getElementById("json-headers-container").style.display =
                isKeyValueMode ? "none" : "block";
            document.getElementById("key-value-headers-container").style.display =
                isKeyValueMode ? "block" : "none";

            document.getElementById("header-mode-text").textContent =
                isKeyValueMode ? "Switch to JSON Mode" : "Switch to Key-Value Mode";

            // Convert between formats when toggling
            if (isKeyValueMode) {
                // JSON -> Key-Value
                const jsonHeaders = document.getElementById("headers").value.trim();
                if (jsonHeaders) {
                    try {
                        const headers = JSON.parse(jsonHeaders);
                        document.getElementById("header-pairs").innerHTML = "";
                        headerPairCount = 0;

                        Object.entries(headers).forEach(([key, value]) => {
                            if (value !== null && value !== undefined) {
                                addHeaderPair(key, value);
                            }
                        });
                    } catch (e) {
                        showMessage("Could not parse JSON headers", true);
                        // Start fresh with empty key-value pairs
                        document.getElementById("header-pairs").innerHTML = "";
                        headerPairCount = 0;
                        addHeaderPair();
                    }
                } else {
                    // If empty, just add one empty pair
                    document.getElementById("header-pairs").innerHTML = "";
                    headerPairCount = 0;
                    addHeaderPair();
                }
            } else {
                // Key-Value -> JSON
                const headers = getRequestHeaders();
                document.getElementById("headers").value = JSON.stringify(headers, null, 2);
            }
        });

        // Add header pair button
        document.getElementById("add-header").addEventListener("click", () => {
            addHeaderPair();
        });

        // Function to add header pair
        function addHeaderPair(key = "", value = "") {
            const pairId = headerPairCount++;
            const headerPairs = document.getElementById("header-pairs");

            const headerPair = document.createElement("div");
            headerPair.className = "header-pair";
            headerPair.id = `header-pair-${pairId}`;

            headerPair.innerHTML = `
                <input type="text" class="header-key" placeholder="Header Key" value="${key.replace(/"/g, '&quot;')}" />
                <input type="text" class="header-value" placeholder="Header Value" value="${value.replace(/"/g, '&quot;')}" />
                <button class="remove-header" data-id="${pairId}">
                    <i class="fas fa-times"></i>
                </button>
            `;

            headerPairs.appendChild(headerPair);

            // Add event listener to the remove button
            headerPair.querySelector(".remove-header").addEventListener("click", (e) => {
                const id = e.currentTarget.getAttribute("data-id");
                document.getElementById(`header-pair-${id}`).remove();
            });
        }

        // Function to add URL to recent list
        function addRecentUrl(url) {
            // Remove if already exists
            recentUrls = recentUrls.filter(item => item.url !== url);

            // Add to beginning
            recentUrls.unshift({
                url: url,
                timestamp: new Date().toISOString()
            });

            // Keep only last 10
            recentUrls = recentUrls.slice(0, 10);

            // Save to localStorage
            localStorage.setItem('recentUrls', JSON.stringify(recentUrls));

            // Update UI
            updateRecentUrlsList();
        }

        // Function to update recent URLs list
        function updateRecentUrlsList() {
            const list = document.getElementById('recent-urls-list');
            list.innerHTML = '';

            recentUrls.forEach((item, index) => {
                const urlItem = document.createElement('div');
                urlItem.className = 'recent-url-item';
                urlItem.innerHTML = `
                    <span class="recent-url-text">${item.url}</span>
                    <i class="url-delete fas fa-trash" data-index="${index}"></i>
                `;

                // Add click handler to play
                urlItem.querySelector('.recent-url-text').addEventListener('click', () => {
                    document.getElementById('hls-url').value = item.url;
                    playStream(item.url);
                });

                // Add click handler to delete
                urlItem.querySelector('.url-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    recentUrls.splice(index, 1);
                    localStorage.setItem('recentUrls', JSON.stringify(recentUrls));
                    updateRecentUrlsList();
                });

                list.appendChild(urlItem);
            });
        }

        // Function to play stream
        function playStream(url) {
            // Show loading spinner
            loading.classList.add('show');

            // Destroy previous HLS instance if exists
            if (currentHls) {
                currentHls.destroy();
                clearInterval(statsInterval);
            }

            // Get headers
            const headers = getRequestHeaders();

            // Configure HLS.js
            const config = {
                maxBufferLength: parseInt(document.getElementById('buffer-length').value),
                maxMaxBufferLength: parseInt(document.getElementById('max-buffer').value),
                enableWorker: document.getElementById('enable-worker').checked,
                lowLatencyMode: document.getElementById('low-latency').checked,
                xhrSetup: (xhr, url) => {
                    // Apply headers to all requests
                    Object.entries(headers).forEach(([key, value]) => {
                        try {
                            // Skip content-type as HLS.js handles it
                            if (key.toLowerCase() !== 'content-type') {
                                xhr.setRequestHeader(key, value);
                            }
                        } catch (e) {
                            console.warn(`Failed to set header ${key}:`, e);
                        }
                    });


                }
            };

            // Create new HLS instance
            currentHls = new Hls(config);

            // Determine if we need to proxy the URL
            let finalUrl = url;
            const needsProxy = url.startsWith('http') &&
                !url.includes('localhost') &&
                !url.includes('127.0.0.1');

            if (needsProxy) {
                // Create URL with headers encoded
                const headersParam = encodeURIComponent(JSON.stringify(headers));
                finalUrl = `${proxyBase}${encodeURIComponent(url)}&headers=${headersParam}`;
            }

            // Load the stream
            try {
                currentHls.loadSource(finalUrl);
                currentHls.attachMedia(player);

                // Event handlers
                currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                    loading.classList.remove('show');
                    document.getElementById('video-info-panel').style.display = 'flex';

                    // Populate quality selector
                    const levels = currentHls.levels;
                    const selector = document.getElementById('quality-selector');
                    selector.innerHTML = '<option value="auto">Auto</option>';

                    if (levels && levels.length > 0) {
                        levels.forEach((level, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = level.height ?
                                `${level.height}p (${Math.round(level.bitrate / 1000)}kbps)` :
                                `Level ${index} (${Math.round(level.bitrate / 1000)}kbps)`;
                            selector.appendChild(option);
                        });
                    }

                    // Start stats update
                    statsInterval = setInterval(updateStats, 1000);

                    // Add to recent URLs
                    addRecentUrl(url);
                });

                currentHls.on(Hls.Events.ERROR, (event, data) => {
                    loading.classList.remove('show');
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showMessage("Network Error - Trying to recover", true);
                                currentHls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showMessage("Media Error - Trying to recover", true);
                                currentHls.recoverMediaError();
                                break;
                            default:
                                showMessage("Fatal Error - Cannot recover", true);
                                currentHls.destroy();
                                break;
                        }
                    }
                });
            } catch (e) {
                loading.classList.remove('show');
                showMessage(`Error loading stream: ${e.message}`, true);
                console.error('Stream load error:', e);
            }
        }
        // Function to update player stats
        function updateStats() {
            if (!currentHls) return;

            // Update buffer length
            const bufferInfo = currentHls.mainForwardBufferInfo;
            if (bufferInfo) {
                document.getElementById('buffer-length').textContent =
                    `${Math.round(bufferInfo.len)}s`;
            }

            // Update current quality
            const level = currentHls.currentLevel;
            const selector = document.getElementById('quality-selector');
            if (level !== -1 && selector.selectedIndex !== level + 1) {
                selector.selectedIndex = level + 1;
            }
        }

        // Quality selector change handler
        document.getElementById('quality-selector').addEventListener('change', (e) => {
            if (!currentHls) return;

            const level = parseInt(e.target.value);
            if (isNaN(level)) {
                currentHls.currentLevel = -1; // Auto
                document.getElementById('current-quality').textContent = 'Auto';
            } else {
                currentHls.currentLevel = level;
                document.getElementById('current-quality').textContent =
                    `${currentHls.levels[level].height}p`;
            }
        });

        // Play button click handler
        document.getElementById('generate-url').addEventListener('click', () => {
            const url = document.getElementById('hls-url').value.trim();
            if (!url) {
                showMessage("Please enter a stream URL", true);
                return;
            }

            playStream(url);
        });

        // Clear button click handler
        document.getElementById('clear-form').addEventListener('click', () => {
            document.getElementById('hls-url').value = '';
            document.getElementById('headers').value = '';
            document.getElementById('header-pairs').innerHTML = '';
            headerPairCount = 0;

            if (currentHls) {
                currentHls.destroy();
                currentHls = null;
            }

            player.src = '';
            document.getElementById('video-info-panel').style.display = 'none';
            clearInterval(statsInterval);
        });

        // Initialize the app
        function init() {
            loadSettings();
            updateRecentUrlsList();

            // Check for HLS support
            if (Hls.isSupported()) {
                showMessage("HLS.js is supported in your browser");
            } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                showMessage("Using native HLS support");
            } else {
                showMessage("HLS is not supported in your browser", true);
            }
        }

        // Start the app
        init();
    </script>
</body>

</html>
